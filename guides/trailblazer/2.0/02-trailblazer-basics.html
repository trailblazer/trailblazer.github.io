<!DOCTYPE html>
<html class="no-js" lang="en">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Trailblazer: 02- Trailblazer Basics</title>
<meta name="description" content="02- Trailblazer Basics - Trailblazer">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="keywords" content=", ">

<!-- style -->
<link rel="shortcut icon" href="/favicon.ico">
<link href="//fonts.googleapis.com/css?family=Open+Sans:300,%20400,700,800%7CRaleway:400,200,700" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="/css/application.css">

<!-- script -->
<script src="/javascripts/jquery.min.js"></script>
<script src="/javascripts/application.min.js"></script>
<script>
  jQuery(document).ready(function($) {
    $(document).foundation();

    anchors.add("article h2");
    anchors.add("article h3");

    hljs.configure({
      languages: ['ruby', 'haml']
    });

    hljs.initHighlightingOnLoad();

    // $('#code-slider').slick({arrows: true, dots: true});
    $('.carousel').slick({arrows: true, dots: true});
  });
</script>


<meta property="og:title" content="02- Trailblazer Basics">
<meta property="og:site_name" content="Trailblazer">
<meta property="og:url" content="http://trailblazer.to/guides/trailblazer/2.0/02-trailblazer-basics.html">
<meta property="og:description" content="">
<meta property="og:image" content="http://trailblazer.to/images/go-trailblazer.jpg">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@apotonick">
<meta name="twitter:title" content="02- Trailblazer Basics">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="http://trailblazer.to/images/go-trailblazer.jpg">

  </head>
  <body>

    <div data-sticky-container class="top-navbar">
  <div class="top-bar sticky" data-sticky data-options="marginTop:0;" style="width:100%">
    <div class="top-bar-title">
      <ul class="menu horizontal">
        <li>
          <a href="/"><img style="height: 25px;" src="/images/logo-top.svg"></a>
        </li>
        <li>
        <span data-responsive-toggle="responsive-menu" data-hide-for="medium">
          <button class="menu-icon" type="button" data-toggle></button>
        </span>
        </li>
      </ul>
    </div>

    <div id="responsive-menu">
      <div class="top-bar-right">
        <ul class="dropdown menu     vertical medium-horizontal" data-dropdown-menu>
          <li><a href="/gems/operation/2.0/release_notes.html">TRB 2.O IS COMING!</a></li>
          <li><a href="https://trbpro.herokuapp.com/">PREMIUM SUPPORT <img alt="Premium Support" src="/images/pro-white.png"></a></li>
          <li><a href="/newsletter/">NEWSLETTER</a></li>
          <li><a href="https://gitter.im/trailblazer/chat" onclick="trackOutboundLink('https://gitter.im/trailblazer/chat'); return false;">CHAT</a></li>
          <li><a href="/guides">GUIDES</a></li>
          <li>
            <a href="#">GEMS</a>
            <ul class="menu vertical">
              <li class=""><a href="/gems/cells">CELLS</a></li>
              <li class=""><a href="/gems/operation/2.0/index.html">OPERATION</a></li>
              <li class=""><a href="/gems/reform">REFORM</a></li>
              <li class=""><a href="/gems/representable">REPRESENTABLE</a></li>
              <li class=""><a href="/gems/roar">ROAR</a></li>
              <li class=""><a href="/gems/disposable">DISPOSABLE</a></li>
            </ul>
          </li>
          <li>
            <a href="https://leanpub.com/trailblazer" class="button secondary" onclick="trackOutboundLink('https://leanpub.com/trailblazer'); return false;">GET THE BOOK</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>


    <!-- Hero -->
<div class="hero gems-hero operation2-hero">
  <div class="hero-unit">
    <div class="expanded row">
      <div class="columns">
        <h1 id="project_title">
          Operation
        </h1>
      </div>
    </div>
  </div>
</div>


    <div class="expanded row">
      <div class="medium-9 large-10 medium-push-3 large-push-2 columns">
        <article class="operation2-body">

          
            <header id="doc-header">
  <h1 class="doc-page-title">02- Trailblazer Basics</h1>
  <span class="doc-last-updated"><i class="fa fa-clock-o" aria-hidden="true"></i> Last updated 23 January 2017</span>

  
    <span class="doc-last-updated">
      <i class="fa fa-diamond" aria-hidden="true"></i>
      <a href="https://github.com/trailblazer/trailblazer">trailblazer</a>

      <a href="/guides/trailblazer/2.0/02-trailblazer-basics.html">
      <span class="version">v2.0</span>
      </a>

    

    </span>
  

  <hr>

</header>

          

          <div class="row"> <!-- nach doc header -->
            <div class="large-9 columns" id="docs">   <!-- actual docs -->
              <section class=" ">
  <div class="row">
    <div class="column medium-8 ">
        <p>Being able to <a href="01-getting-started-with-operation.html">populate the pipe</a>, or railway, of an operation and handle errors, we now dive into the Trailblazer gem and the abstractions it gives us: persistence handling, validations, policies, and all that.</p>

<p>An importance architectural decision here is that most abstractions are implemented in completely separate gems. Those gems don’t even know they’re being used in a Trailblazer operation.</p>

<p>Instead of shipping with tons of code to implement forms or policies, Trailblazer provides glue code that mediate between the operation (flow control and specific customization) and the additional abstractions (validations, persistence, etc.).</p>

<p>This happens in <em>macros</em>, and we will learn a lot about those in the following session.</p>


      </div>
    <div class="column medium-4 ">
        <p><img src="/images/diagrams/operation-2017-small.png" class="diagram left"></p>

      </div>
</div></section>

<h2 id="the-challenge" data-magellan-target="the-challenge">The Challenge</h2>

<p>Coming back to the controller from chapter 01, I want you to quickly get an idea of what we’re trying to achieve now.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>class BlogPostsController &lt; RubyOnTrails::Controller
  before_filter :authorize_user!

  def create
    post = BlogPost.new
    post.update_attributes(params[:blog_post])
    if post.save
      notify_current_user!
    else
      render
    end
  end
end
</code></pre>
</div>

<p>This is a classic Rails controller setup. Check if the user is authorized, create a model, validate the incoming parameters, if successful, save and notify the current user about it.</p>

<p>We’re going to rebuild this with a Trailblazer operation. We’re also going to do that without any infrastructure framework, such as Rails or Hanami. This is content for the following guides.</p>

<div class="callout">
  
<p>Code for this session is <a href="https://github.com/trailblazer/guides/tree/operation-02">here</a>.</p>

</div>

<h2 id="wat" data-magellan-target="wat">WAT</h2>

<p>Trailblazer is suitable both for greenfield projects as well as refactoring massive and messy legacy projects. The mechanics are always the same.</p>

<ul>
  <li>Extract domain logic from controller, models and half-baked service objects and rearrange them embraced by an operation.</li>
  <li>Free the model: Validations go to forms (or contracts as we also call them).</li>
  <li>Callback code is triggered from the operation, not the model or controller.</li>
  <li>Authorization happens in policies orchestrated by the operation, not in random places in controller, model, or view.</li>
</ul>

<p>You will see, it’s actually quite simple to let the operation control the flow and other stakeholder objects implement the specifics.</p>

<h2 id="gemfile" data-magellan-target="gemfile">Gemfile</h2>

<p>Have a look at the <code class="highlighter-rouge">Gemfile</code>.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>gem "trailblazer"
gem "activerecord"
gem "sqlite3"
gem "rspec"
gem "dry-validation"
</code></pre>
</div>

<p>The <code class="highlighter-rouge">trailblazer</code> gem brings the operation, the Reform gem for contracts, and some code for the macros we’re going to discuss.</p>

<p>We already discussed <code class="highlighter-rouge">rspec</code>’s role. Mentioning the <code class="highlighter-rouge">activerecord</code> gem is important, since we need a persistence layer. Please be advised, though, that Trailblazer is database-agnostic: you can use ROM, <code class="highlighter-rouge">Hanami::Model</code>, Sequel, or whatever else you feel like.</p>

<p>For validations, we refrain from using <code class="highlighter-rouge">ActiveModel::Validation</code> in this example and use the excellent <a href="dry-rb.org/gems/dry-validation/">dry-validation gem</a>. Reform allows using <code class="highlighter-rouge">dry-v</code> out-of-the-box. In case you want to/have to use ActiveModel’s validations, no problem, Reform does that, too.</p>

<h2 id="model" data-magellan-target="model">Model</h2>

<p>Since we’re going to create a new blog post record, it’s a good idea to add a model class. I put that in <code class="highlighter-rouge">app/models/blog_post.rb</code>.</p>

<pre><code>class BlogPost &lt; ActiveRecord::Base
end
</code></pre>

<p>This is an empty model that skips all the features of ActiveRecord’s that should’ve never been added, and leverages what ActiveRecord is amazing at: persistence.</p>

<div class="callout">
  
<p>We also <a href="https://github.com/trailblazer/guides/blob/operation-02/app/models/user.rb">have a <code>User</code> model</a>, which is a simple Struct that allows us to set a <code>signed_in?</code> flag. In later chapters we will use a “real” user model and an authentication gem.</p>

</div>

<h2 id="procedural-approach" data-magellan-target="procedural-approach">Procedural Approach</h2>

<p>To implement the above controller action in an operation, you could simply throw the code into a single step, ignoring all the nice mechanics and error handling that comes with the pipe, but making it “understandable” to a new developer.</p>

<p>For illustration purposes, this <code class="highlighter-rouge">Create</code> operation goes to <code class="highlighter-rouge">app/concepts/blog_post/operation/create.rb</code>.</p>

<pre><code>require "trailblazer"

class BlogPost::Create &lt; Trailblazer::Operation
  step :do_everything!

  def do_everything!(options, params:, current_user:, **)
    return unless current_user.signed_in?

    model = BlogPost.new
    model.update_attributes(params[:blog_post])

    if model.save
      BlogPost::Notification.(current_user, model)
    else
      return false
    end
  end
end
</code></pre>

<p>The operation now orchestrates model, validation and the notification “callback” that used to sit in the controller. Note that no HTTP-related code, like redirects or rendering results, is found here anymore. That’s a step forward in our quest to separating concerns!</p>

<h3 id="procedural-approach-test">Procedural Approach: Test</h3>

<p>A quick test makes sure that our authorization kicks in and an anonymous user leads to a failing operation, and no model is persisted.</p>

<pre><code>require "spec_helper"
require_relative "../../../../app/models/user"
require_relative "../../../../app/models/blog_post"
require_relative "../../../../app/concepts/blog_post/operation/create"

RSpec.describe BlogPost::Create do
  let (:anonymous) { User.new(false) }
  let (:signed_in) { User.new(true) }
  let (:pass_params) { { blog_post: { title: "Puns: Ode to Joy" } } }

  it "fails with anonymous" do
    result = BlogPost::Create.(pass_params, "current_user" =&gt; anonymous)

    expect(result).to be_failure
    expect(BlogPost.last).to be_nil
  end
</code></pre>

<p>We also test the <a href="https://github.com/trailblazer/guides/blob/operation-02/spec/concepts/blog_post/operation/create_spec.rb#L21">successful case here</a>. It’s obvious that our current implementation is not great, for example, we don’t have access to the created model without manual work, which we don’t favor, do we?</p>

<h2 id="dependencies" data-magellan-target="dependencies">Dependencies</h2>

<p>Even though this operation is far from ideal, it demonstrates a very important concept in Trailblazer. Have you noticed how we pass in and access the current user?</p>

<p>There is no global state in Trailblazer, everything you need in the operation needs to go in via <code class="highlighter-rouge">call</code>.</p>

<p>The first argument is usually the framework’s <code class="highlighter-rouge">params</code> has <a href="01-getting-started-with-operation.html#options">as discussed here</a>. The second argument can be any hash specifying the dependencies needed in the operation, such as the current user.</p>

<pre><code>result = BlogPost::Create.(pass_params, "current_user" =&gt; signed_in)
</code></pre>

<p>By passing the current user with a string key, you will be able to access it via <code class="highlighter-rouge">options</code> in all steps. And, of course, you as the attentive reader still remember that you can use keyword arguments to grab that current user (or whatever else you need from the options) in a local variable.</p>

<pre><code>def do_everything!(options, params:, current_user:, **)
  return unless current_user.signed_in?
</code></pre>

<p>Here’s what to remember about dependencies in a snapshot.</p>

<ul>
  <li>Every dependency needs to go in via <code class="highlighter-rouge">call</code>, whether that is in a controller, a test, or a background job.</li>
  <li>Use <a href="https://robots.thoughtbot.com/ruby-2-keyword-arguments#required-keyword-arguments"><em>required</em> kw args</a> wherever you can, as they will automatically raise an exception should the required keyword be absent.</li>
</ul>

<h2 id="exposing-values" data-magellan-target="exposing-values">Exposing Values</h2>

<p>Before breaking up this monolith into small, flexible steps, it’s a good time to learn how we can communicate values to the caller via the result object. You remember, in our specs, in order to grab the model for specing, we had to use <code class="highlighter-rouge">BlogPost.last</code> - which yields potential for bugs.</p>

<p>Instead, we can simply write values to the <code class="highlighter-rouge">options</code> object. Those will be accessable to all following steps, as we’ll see in a few seconds.</p>

<pre><code>def do_everything!(options, params:, current_user:, **)
  return unless current_user.signed_in?

  model = BlogPost.new
  options["model"] = model # readable in steps and result.

  model.update_attributes(params[:blog_post])
  # ...
end
</code></pre>

<p>Writing to <code class="highlighter-rouge">options</code> will also allow to read that very value in the result object, allowing us to change the specs slightly.</p>

<pre><code>it "fails with anonymous" do
  result = BlogPost::Create.(pass_params, "current_user" =&gt; anonymous)

  expect(result).to be_failure
  expect(result["model"]).to be_nil
end
</code></pre>

<p>We can now test against <code class="highlighter-rouge">result["model"]</code> and retrieve the actual processed model instance.</p>

<h2 id="manual-steps" data-magellan-target="manual-steps">Manual Steps</h2>

<p>While all this works fine, we actually don’t need an operation for this procedural piece of code. We could put that in one of the “service objects” that spook through many Ruby applications out there.</p>

<p>Splitting up the procedural logic into steps will give us a better code structure and automatic error handling. Going further, using Trailblazer macros instead of manual steps, we will maximise stability and get helpful statuses in the result object.</p>

<pre><code>class BlogPost::Create &lt; Trailblazer::Operation
  step :authorize!
  step :model!
  step :persist!
  step :notify!

  def authorize!(options, current_user:, **)
    current_user.signed_in?
  end

  def model!(options, **)
    options["model"] = BlogPost.new
  end

  def persist!(options, params:, model:, **)
    model.update_attributes(params[:blog_post])
    model.save
  end

  def notify!(options, current_user:, model:, **)
    BlogPost::Notification.(current_user, model)
  end
end
</code></pre>

<p>Four steps now implement the exact same that we did in one procedural step. As you can see, error handling and <code class="highlighter-rouge">if</code>s disappeared because if a step returns a falsey value, the remaining steps will be skipped. I also advise you to take a minute and check out how we use different kw args per step - this is such a helpful feature, you should use it and understand it.</p>

<p>The specs we wrote still pass, so we’re good to go to the next step.</p>

<h2 id="policy" data-magellan-target="policy">Policy</h2>

<p>One big advantage of Trailblazer’s <code class="highlighter-rouge">Policy</code> macro over our home-made <code class="highlighter-rouge">authorize!</code> step is: It will add its outcome to the result object, making it extremely simple to track what went wrong should things go wrong.</p>

<p>The other benefit of using this macro is: You don’t have to use <a href="/gems/operation/2.0/policy.html#guard">the primitive <em>guard</em> implementation</a>, but use your existing <a href="/gems/operation/2.0/policy.html#pundit">Pundit-style policies</a> to intercept unauthorized users.</p>

<p>For simplicity, let’s go with the <code class="highlighter-rouge">Guard</code> macro for now.</p>

<pre><code>class BlogPost::Create &lt; Trailblazer::Operation
  step Policy::Guard( :authorize! )
  step :model!
  step :persist!
  step :notify!

  def authorize!(options, current_user:, **)
    current_user.signed_in?
  end

  def model!(options, **)
    options["model"] = BlogPost.new
  end

  def persist!(options, params:, model:, **)
    model.update_attributes(params[:blog_post])
    model.save
  end

  def notify!(options, current_user:, model:, **)
    BlogPost::Notification.(current_user, model)
  end
end
</code></pre>

<p>Check line 2. Guards are a good way to quickly implement access control, but I advise you to invest some time in a separated policy implementation such as <a href="(/gems/operation/2.0/policy.html#pundit)">pundit</a>.</p>

<p>All <code class="highlighter-rouge">Policy</code> macros will leave a trace in the operation’s result object. Here’s the test snippet for anonymous users who will be declined.</p>

<pre><code>it "fails with anonymous" do
  result = BlogPost::Create.(pass_params, "current_user" =&gt; anonymous)

  expect(result).to be_failure
  expect(result["model"]).to be_nil
  expect(result["result.policy.default"]).to be_failure
end
</code></pre>

<p>In other words: every <code class="highlighter-rouge">Policy</code> macro creates its own result object within the operation result. With <code class="highlighter-rouge">Guard</code>, you can only ask for validity.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>result["result.policy.default"].success?
</code></pre>
</div>

<p>However, with <code class="highlighter-rouge">Pundit</code> policies, additional messages will be accessable via this “nested” result object. This is a great way to find out what happened in the operation should you get an unexpected invalid result.</p>

<h2 id="model-1" data-magellan-target="model-1">Model</h2>

<p>Trailblazer also has a convenient way to handle model creation and finding. The <code class="highlighter-rouge">Model</code> macro literally does what our <code class="highlighter-rouge">model!</code> step did.</p>

<pre><code>class BlogPost::Create &lt; Trailblazer::Operation
  step Policy::Guard( :authorize! )
  step Model( BlogPost, :new )
  step :persist!
  step :notify!

  def authorize!(options, current_user:, **)
    current_user.signed_in?
  end

  def persist!(options, params:, model:, **)
    model.update_attributes(params[:blog_post])
    model.save
  end

  def notify!(options, current_user:, model:, **)
    BlogPost::Notification.(current_user, model)
  end
end
</code></pre>

<p>This shortens our code even more, and reduces possible bugs. Of course, <code class="highlighter-rouge">Model</code> can also <a href="http://localhost:4000/gems/operation/2.0/api.html#model-findby">find records</a> as we will discover in the next chapter.</p>

<p>Note that <code class="highlighter-rouge">Model</code> is <em>not</em> designed for complex query logic - should you need that, you might want to write your own step, use a query object or even combine both in a macro. Also, you can maintain multiple models, should you require that.</p>

<p>The specs still pass, as we haven’t changed public behavior.</p>

<h2 id="contract" data-magellan-target="contract">Contract</h2>

<p>As a next step, or better, as next steps, we need to bring the validation into the operation. Remember, in Trailblazer, you don’t want validations in the model or the controller. These go into <em>contracts</em>.</p>

<p>Contracts are basically validations, and they can be simple callable objects you write yourself, or <code class="highlighter-rouge">Dry::Schema</code>s, or, and that’s what we do in this example, Reform objects. Luckily, the <code class="highlighter-rouge">Contract</code> macros make dealing with contracts (or forms, it’s the same!) very simple.</p>

<pre><code>require_relative "../contract/create"

class BlogPost::Create &lt; Trailblazer::Operation
  step Policy::Guard( :authorize! )
  step Model( BlogPost, :new )
  step Contract::Build( constant: BlogPost::Contract::Create )
  step Contract::Validate( key: :blog_post )
  step :persist!
  step :notify!

  def authorize!(options, current_user:, **)
    current_user.signed_in?
  end

  def persist!(options, params:, model:, **)
    model.save
  end

  def notify!(options, current_user:, model:, **)
    BlogPost::Notification.(current_user, model)
  end
end
</code></pre>

<p>As you can see, we added two steps after <code class="highlighter-rouge">Model</code>, and reduced the logic in <code class="highlighter-rouge">persist!</code> to saving the model. This code will break, but it’s great to show you some mechanics with contracts, so bear with me.</p>

<h2 id="build" data-magellan-target="build">Build</h2>

<p>The first new step is <code class="highlighter-rouge">Contract::Build</code>.</p>

<pre><code>step Contract::Build( constant: BlogPost::Contract::Create )
</code></pre>

<p>Even though Trailblazer allows to have <a href="/gems/operation/2.0/contract.html#overview-reform">“inline contracts”</a>, we don’t want to clutter our operation with additional validation code. This is why I use the <code class="highlighter-rouge">:constant</code> option to tell <code class="highlighter-rouge">Contract::Build</code> what contract class to use.</p>

<p>Don’t try to understand everything at once right now, just believe me that <code class="highlighter-rouge">Contract::Build</code> will create this mysterious contract class and pass it the operation’s model.</p>

<p>Have a look at this contract in <code class="highlighter-rouge">app/concepts/blog_post/contract/create.rb</code>.</p>

<pre><code>require "reform"
require "reform/form/dry"

module BlogPost::Contract
  class Create &lt; Reform::Form
    include Dry

    property :title
    property :body

    validation do
      required(:title).filled
      required(:body).maybe(min_size?: 9)
    end
  end
end
</code></pre>

<p>Without going into too much detail about contracts (they have their own guides), it’s obvious that this contract defines its fields with <code class="highlighter-rouge">property</code> and then uses dry-validation’s specific DSL to create a validation chain.</p>

<pre><code>validation do
  required(:title).filled
  required(:body).maybe(min_size?: 9)
end
</code></pre>

<p>We simply define <code class="highlighter-rouge">title</code> as a required field, which must not be blank. Also, the <code class="highlighter-rouge">body</code> might filled, and if it is, it should be 9 characters minimum. Dry-validation needs a few minutes to sink in, but then it is so much more powerful and readable than the outdated <code class="highlighter-rouge">ActiveModel::Validations</code>.</p>

<p>The <code class="highlighter-rouge">Build</code> macro will always pass the operation’s default model to the contract constructor and save the contract instance in <code class="highlighter-rouge">options</code>. What goes on here is this.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code># pseudo code
Contract::Build()
  options["contract.default"] = BlogPost::Contract::Create.new(options["model"])
</code></pre>
</div>

<p>Again, no need to understand this right now, should you be unexperienced with Reform. We will go that at a later point.</p>

<div class="callout">
  
<p>For those who know Reform: after <code>Contract::Build</code>, you always have the contract instance in <code>options["contract.default"]</code>.</p>

</div>

<h2 id="validation" data-magellan-target="validation">Validation</h2>

<p>Now, whatever building the contract implies, how do we run that <em>validation</em> against the incoming parameters?</p>

<p>Here’s a passing spec snippet.</p>

<pre><code>result = BlogPost::Create.(
  { blog_post: { title: "Puns: Ode to Joy", body: "" } },
  "current_user" =&gt; signed_in
)
</code></pre>

<p>In the test case, we pass in a manual hash to <code class="highlighter-rouge">call</code>, but in, say, a Rails app, this would be the params hash. This input is now validated via the <code class="highlighter-rouge">Contract::Validate</code> macro.</p>

<pre><code>step Contract::Validate( key: :blog_post )
</code></pre>

<p>Again, Reform’s API will be utilized here by Trailblazer. We discussed earlier that the operation is only an orchestrator knowing how to operate abstractions such as the contract, but it has no idea how.</p>

<p>What <code class="highlighter-rouge">Contract::Validate</code> will do at run-time could be expressed as follows.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code># pseudo code
Contract::Validate( key: :blog_post )
  reform_contract = options["contract.default"]
  result = reform_contract.validate(options["params"][:blog_post])
</code></pre>
</div>

<p>In a nutshell, Trailblazer uses the contract’s <code class="highlighter-rouge">validate</code> method, passes in the fragment from the <code class="highlighter-rouge">params</code> hash you provided, and lets Reform sort out validations, generating error messages and providing an actual result for us. If that fails due to insufficient input, <code class="highlighter-rouge">Contract::Validate</code> will deviate to the left track and no further steps will be executed.</p>

<div class="callout">
  
<p>It is incredibly important to understand the <code>:key</code> option here. <code>Validate</code> will extract the <code>blog_post:</code> fragment from the params hash, if you provide the <code>:key</code> option, and it won’t continue if it can’t find this key.</p>

<p>Omitting <code>:key</code>, <code>Validate</code> will try to validate the entire params hash, which is fine if you don’t use wrappers. However, gems like <code>simple_form</code> always add this wrap, so be weary.</p>

</div>

<p>Also, please note that Reform’s validation takes away the need for <code class="highlighter-rouge">strong_parameters</code>. Since all desired input fields were declared using <code class="highlighter-rouge">property</code> in the contract, it can simply filter out other irrelevant keys.</p>

<pre><code>property :title
property :body
</code></pre>

<p>You don’t need <code class="highlighter-rouge">strong_parameters</code> with Trailblazer.</p>

<h2 id="errors" data-magellan-target="errors">Errors</h2>

<p>Let’s play a bit with different input for our operation to learn how errors can be extracted from the result object.</p>

<p>In the first spec, we completely fail to provide any sensible input.</p>

<pre><code>it "fails with missing input" do
  result = BlogPost::Create.({}, "current_user" =&gt; signed_in)
  expect(result).to be_failure
end
</code></pre>

<p>Here, the <code class="highlighter-rouge">blog_post:</code> fragment in the params hash is completely missing, the validation is not even triggered. That is, because the extraction of the <code class="highlighter-rouge">blog_post:</code> fragment fails, which leads to a failed operation without any error message.</p>

<div class="callout">
  
<p>In upcoming versions of TRB, this specific failure will be indicated better.</p>

</div>

<p>The next spec sends a <code class="highlighter-rouge">body</code> with the wrong length - it must be more than 9 characters long. Why, we don’t know, but the business asks for this validation.</p>

<pre><code>it "fails with body too short" do
  result = BlogPost::Create.(
    { blog_post: { title: "Heatwave!", body: "Too hot!" } },
    "current_user" =&gt; signed_in
  )

  expect(result).to be_failure
  expect(result["result.contract.default"].errors.messages).to eq(
    {:body =&gt; ["size cannot be less than 9"]} )
end
</code></pre>

<p>By inspecting the contract’s <code class="highlighter-rouge">errors</code> object, we can assert that our validations work. It’s usually best to test the error messages to see if and what validations were triggered.</p>

<div class="callout">
  
<p>We are working on <code>trailblazer-test</code> that will provide matchers for Minitest and Rspec to have less verbose tests.</p>

</div>

<p>Trailblazer tries to abstract the Reform or dry-validation internals from you, so you can always access the contract’s result field in the result object for errors and state. This also works pretty well when using form builders, which we will see in the next chapter.</p>

<h2 id="persist" data-magellan-target="persist">Persist</h2>

<p>When running our to-be-successful test case, whatsoever, it still breaks.</p>

<pre><code>it "works with known user" do
  result = BlogPost::Create.(
    { blog_post: { title: "Puns: Ode to Joy", body: "" } },
    "current_user" =&gt; signed_in
  )
  expect(result).to be_success
  expect(result["model"]).to be_persisted
  expect(result["model"].title).to eq("Puns: Ode to Joy") # fails!
end
</code></pre>

<p>The error message here will give us some hint.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>Failure/Error: expect(result["model"].title).to eq("Puns: Ode to Joy") # fails!

expected: "Puns: Ode to Joy"
     got: nil
</code></pre>
</div>

<p>Apparently, the operation’s <code class="highlighter-rouge">BlogPost</code> model got persisted, but it’s empty. No attributes were assigned, even though they were valid.</p>

<p>This is because when validating the input, this all happens in the <em>contract</em>. Values to-be-validated are written and checked on the contract instance, not on the model. The model is not touched until we say so.</p>

<p>In other words: what we need is to push the validated data from contract to the model, and then save the model. This can be done with the <code class="highlighter-rouge">Contract::Persist</code> macro.</p>

<pre><code>require_relative "../contract/create"

class BlogPost::Create &lt; Trailblazer::Operation
  step Policy::Guard( :authorize! )
  step Model( BlogPost, :new )
  step Contract::Build( constant: BlogPost::Contract::Create )
  step Contract::Validate( key: :blog_post )
  step Contract::Persist()
  step :notify!

  def authorize!(options, current_user:, **)
    current_user.signed_in?
  end

  def notify!(options, current_user:, model:, **)
    options["result.notify"] = BlogPost::Notification.(current_user, model)
  end
end
</code></pre>

<p>Replacing our own step, <code class="highlighter-rouge">Persist</code> will use Reform’s API to push the data to the model. In pseudo code, this is what takes place.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code># pseudo code
Contract::Persist( )
  reform_contract = options["contract.default"]
  reform_contract.save
</code></pre>
</div>

<p>The <a href="http://localhost:4000/gems/reform/api.html#save">contract’s <code class="highlighter-rouge">save</code> method</a> does exactly that for us, plus it saves the model.</p>

<p>And… our tests pass!</p>

<p>BTW, another nice thing is: if the model’s save returns false, this will also result in the pipe jumping to the left track, skipping our last step <code class="highlighter-rouge">notify!</code></p>

<h2 id="notify" data-magellan-target="notify">Notify</h2>

<p>Speaking of <code class="highlighter-rouge">notify!</code>, this is the last step we need to review, and then you’re can call yourself a Trailblazer expert. In the current state of our application, <code class="highlighter-rouge">Notification</code> is just an empty class doing nothing.</p>

<p>To sum up this chapter, I would like to keep it that way. A dedicated guide will talk about post-processing logic (<em>callbacks</em>), testing and mocking external services like mailers with dependency injections.</p>

<h2 id="summary" data-magellan-target="summary">Summary</h2>

<p>You’re now ready to write full-blown operations implementing the entire workflow for a function of an application. Even though you could do all the steps yourself the TRB macros help you in doing so.</p>

<p>There might be open questions around contracts, but we will discuss them in a separate guide. If you can’t wait for it, have a look at the Trailblazer book, page 51 et seq. explain Reform in great detail.</p>

<p>In the next chapter we will discover how to use operations in Rails, where HTML forms get rendered and send input to endpoints. Exciting stuff!</p>

            </div>

            <div class="large-3 columns sticky-container" data-sticky-container>

              
                <nav class="sticky columns docs-toc-wrap sticky is-anchored is-at-top side-nav" data-sticky data-anchor="docs" data-sticky-on="large" data-margin-top="5">
  
        <ul class="vertical menu" data-magellan id="page-toc">
          <li class="page-toc-heading">ON THIS PAGE:</li>
          <li><a href="#the-challenge">The Challenge</a></li>
<li><a href="#wat">WAT</a></li>
<li><a href="#gemfile">Gemfile</a></li>
<li><a href="#model">Model</a></li>
<li><a href="#procedural-approach">Procedural Approach</a></li>
<li><a href="#dependencies">Dependencies</a></li>
<li><a href="#exposing-values">Exposing Values</a></li>
<li><a href="#manual-steps">Manual Steps</a></li>
<li><a href="#policy">Policy</a></li>
<li><a href="#model-1">Model</a></li>
<li><a href="#contract">Contract</a></li>
<li><a href="#build">Build</a></li>
<li><a href="#validation">Validation</a></li>
<li><a href="#errors">Errors</a></li>
<li><a href="#persist">Persist</a></li>
<li><a href="#notify">Notify</a></li>
<li><a href="#summary">Summary</a></li>
        </ul>
      
</nav>

              

            </div>
          </div>
        </article>
      </div>

      <div class="medium-3 large-2 medium-pull-9 large-pull-10 columns">
        <ul class="vertical menu side-nav">
    <li class="heading">
        <a href="/gems/operation/2.0/index.html">
            <i class="fa fa-caret-square-o-right" aria-hidden="true"></i> OPERATION
        </a>
    </li>
    <li><a href="/gems/operation/2.0/api.html">API</a></li>
    <li><a href="/gems/operation/2.0/contract.html">Contract</a></li>
    <!-- <li><a href="/gems/operation/2.0/representer.html">Representer</a></li> -->
    <li><a href="/gems/operation/2.0/policy.html">Policy</a></li>
    <li><a href="/gems/operation/2.0/representer.html">Representer</a></li>
<!--     <li><a href="/gems/operation/2.0/pipetree.html">Pipetree</a></li>
 -->
    <li><a href="/gems/operation/2.0/endpoint.html">Endpoint</a></li>
    <li>
<a href="/gems/operation/1.1/index.html">
          <span class="sidebar-info">→ v1.1</span>
        </a>
    </li>
    <li class="divider">

    <li class="heading">
        <a href="/gems/trailblazer/index.html">
            <i class="fa fa-caret-square-o-right" aria-hidden="true"></i> TRAILBLAZER
        </a>
    </li>
    <li><a href="/gems/trailblazer/2.0/rails.html">Rails</a></li>
    <li><a href="/gems/trailblazer/loader.html">Loader</a></li>
    <li class="divider">

    <li class="heading">
        <a href="/gems/cells">
            <i class="fa fa-caret-square-o-right" aria-hidden="true"></i> CELLS
        </a>
    </li>
    <li><a href="/gems/cells/getting-started.html">Getting Started<span class="sidebar-info">NEW</span></a></li>
    <li><a href="/gems/cells/api.html">API</a></li>
    <li><a href="/gems/cells/trailblazer.html">Trailblazer::Cell</a></li>
    <li><a href="/gems/cells/testing.html">Testing</a></li>
    <li><a href="/gems/cells/render.html">Rendering</a></li>
    <li><a href="/gems/cells/rails.html">Rails</a></li>
    <li><a href="/gems/cells/templates.html">Templates</a></li>
    <li><a href="/gems/cells/troubleshooting.html">Troubleshooting</a></li>
    <li class="divider">

    <li class="heading">
        <a href="/gems/reform">
            <i class="fa fa-caret-square-o-right" aria-hidden="true"></i> REFORM
        </a>
    </li>
    <li><a href="/gems/reform/api.html">API</a></li>
    <li><a href="/gems/reform/options.html">Options</a></li>
    <li><a href="/gems/reform/data-types.html">Data Types</a></li>
    <li><a href="/gems/reform/populator.html">Populator</a></li>
    <li><a href="/gems/reform/prepopulator.html">Prepopulator</a></li>
    <li><a href="/gems/reform/validation.html">Validation</a></li>
    <li><a href="/gems/reform/rails.html">Rails</a></li>
    <li><a href="/gems/reform/debugging.html">Debugging</a></li>
    <li><a href="/gems/reform/upgrading-guide.html">Upgrading Guide</a></li>
    <li class="divider">

    <li class="heading">
        <a href="/gems/representable">
            <i class="fa fa-caret-square-o-right" aria-hidden="true"></i> REPRESENTABLE
        </a>
    </li>
    <li><a href="/gems/representable/getting-started.html">Getting Started</a></li>
    <li><a href="/gems/representable/3.0/api.html">API</a></li>
    <li><a href="/gems/representable/3.0/function-api.html">Function API</a></li>
    <li><a href="/gems/representable/3.0/populator.html">Populator</a></li>
    <!-- <li><a href="/gems/representable/architecture.html">Architecture</a></li> -->
    <li><a href="/gems/representable/3.0/xml.html">XML</a></li>
    <li><a href="/gems/representable/3.0/yaml.html">YAML</a></li>
    <li><a href="/gems/representable/upgrading-guide.html">Upgrading Guide</a></li>
    <li class="divider">

    <li class="heading">
        <a href="/gems/roar">
            <i class="fa fa-caret-square-o-right" aria-hidden="true"></i> ROAR
        </a>
    </li>
    <li><a href="/gems/roar/jsonapi.html">JSON API</a></li>
    <li class="divider">

    <li class="heading">
        <a href="/gems/disposable">
            <i class="fa fa-caret-square-o-right" aria-hidden="true"></i> DISPOSABLE
        </a>
    </li>
    <li><a href="/gems/disposable/api.html">API</a></li>
    <li><a href="/gems/disposable/default.html">Default</a></li>
    <li><a href="/gems/disposable/callback.html">Callback</a></li>
    <li class="divider">

    <li class="heading">
        <a href="/guides">
            <i class="fa fa-caret-square-o-right" aria-hidden="true"></i> GUIDES
        </a>
    </li>
    <li><a href="/guides/trailblazer/2.0/01-getting-started-with-operation.html">01- Getting Started with Operation</a></li>
    <li><a href="/guides/getting-started.html">Getting Started</a></li>
    <li><a href="/guides/sinatra/getting-started.html">Sinatra</a></li>
    <li><a href="/guides/grape.html">Grape</a></li>
</ul>

      </div>
    </div>


    <section class="top-footer">
  <div class="row">
    <div class="columns medium-6">
      <h3>Newsletter</h3>
      <p>
        Stay on top of what’s happening in Trailblazer.
      </p>
        <div class="row">
          <div id="mc_embed_signup">
            <form action="//trailblazerb.us8.list-manage.com/subscribe/post?u=bbe5021ab6fbdc94a16f0d036&amp;id=a69f6e4652" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>

              <div class="columns large-9 medium-12 ">
                <div class="row collapse prefix-radius">
                  <div class="small-8 medium-7 large-8 columns">
                    <div id="mc_embed_signup_scroll">
                      <div class="mc-field-group">
                        <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="youremail@trailblazer.to">
                      </div>
                      <div id="mce-responses" class="clear">
                        <div class="response" id="mce-error-response" style="display:none"></div>
                        <div class="response" id="mce-success-response" style="display:none"></div>
                      </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
                      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_bbe5021ab6fbdc94a16f0d036_a69f6e4652" tabindex="-1" value=""></div>

                    </div>
                  </div>
                  <div class="small-4 medium-5 large-4 columns">
                    <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button postfix secondary">
                  </div>
                </div>
              </div>
            </form>
          </div>
          <script type="text/javascript" src="//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js"></script><script type="text/javascript">(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
        </div>
      <p>
        And check out the <a href="/newsletter/">archive of newsletters</a>!
      </p>


    </div>
    <div class="columns medium-6">
      <h3>The Book</h3>
      <p>Learn how to build a Rails app with Trailblazer, step-by-step.</p>
      <a href="https://leanpub.com/trailblazer" class="button secondary">Get the book!</a>
    </div>
  </div>
</section>

<footer>
  <div class="row">
    <div class="columns medium-4">
      <div class="logo-box">
        <a href="/"><img src="/images/icon_trb.png">
        </a>
      </div>
    </div>
    <div class="columns medium-8">
      <div class="row">
        <div class="columns medium-6">
          <h4>
            Trailblazer
          </h4>
          <ul class="no-bullet">
            <li><a href="https://gitter.im/trailblazer/chat">Gitter chat</a></li>
            <li><a href="https://leanpub.com/trailblazer" onclick="trackOutboundLink('https://leanpub.com/trailblazer'); return false;">The book</a></li>
          </ul>
        </div>
        <div class="columns medium-6">
          <h4>
            Follow Us
          </h4>
          <ul class="menu">
            <li>
              <a href="https://github.com/trailblazer">
                <i class="footer-icon github-icon"></i>
              </a>
            </li>
            <li>
              <a href="https://twitter.com/apotonick">
                <i class="footer-icon twitter-icon"></i>
              </a>
            </li>
            <li>
              <a href="https://facebook.com/trbinc">
                <i class="footer-icon facebook-icon"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
      <p class="copyright">
        Trailblazer is created by <a href="http://www.synergysoft.com.sg/">Synergy Software Solutions Pte Ltd,</a> and awesome friends.
      </p>
      <p class="copyright">
        Site designed and handcoded with love by <a href="https://twitter.com/noeliacabane">Noelia Cabane</a>
      </p>
    </div>
  </div>
</footer>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-69514939-1', 'auto');
  ga('send', 'pageview');

  /**
  * Function that tracks a click on an outbound link in Analytics.
  * This function takes a valid URL string as an argument, and uses that URL string
  * as the event label. Setting the transport method to 'beacon' lets the hit be sent
  * using 'navigator.sendBeacon' in browser that support it.
  */
  var trackOutboundLink = function(url) {
     ga('send', 'event', 'outbound', 'click', url, {
       'transport': 'beacon',
       'hitCallback': function(){document.location = url;}
     });
  }
</script>



  </body>
</html>
